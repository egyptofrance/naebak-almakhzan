# Naebak Testing Scenarios - ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ ุงูุดุงููุฉ

## ๐งช **ุงุณุชุฑุงุชูุฌูุฉ ุงูุงุฎุชุจุงุฑ**

### **ุฃููุงุน ุงูุงุฎุชุจุงุฑุงุช:**
1. **Unit Tests** - ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ (70%)
2. **Integration Tests** - ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู (20%)
3. **End-to-End Tests** - ุงุฎุชุจุงุฑุงุช ุดุงููุฉ (10%)

### **ูุนุงููุฑ ุงููุฌุงุญ:**
- **ุชุบุทูุฉ ุงูููุฏ**: 85%+ 
- **ูุนุฏู ุงููุฌุงุญ**: 95%+
- **ููุช ุงูุชูููุฐ**: < 10 ุฏูุงุฆู ููุฌููุน
- **ุงุฎุชุจุงุฑุงุช ุงูุฃูุงู**: 100% ูุฌุงุญ

---

## ๐ **1. ุงุฎุชุจุงุฑุงุช ุงููุตุงุฏูุฉ ูุงูุฃูุงู**

### **1.1 ุชุณุฌูู ุงููุณุชุฎุฏู ุงูุฌุฏูุฏ**

#### **ุงูุณููุงุฑูู ุงูุฅูุฌุงุจู:**
```python
def test_user_registration_success():
    """ุงุฎุชุจุงุฑ ุชุณุฌูู ูุณุชุฎุฏู ุฌุฏูุฏ ุจูุฌุงุญ"""
    data = {
        "username": "ahmed_cairo",
        "email": "ahmed@example.com",
        "phone": "01012345678",
        "whatsapp": "01012345678",
        "full_name": "ุฃุญูุฏ ูุญูุฏ ุนูู",
        "address": "ุดุงุฑุน ุงููููุ ุงููุงูุฑุฉ",
        "governorate_id": 1,  # ุงููุงูุฑุฉ
        "user_type": "citizen",
        "password": "SecurePass123!"
    }
    
    response = client.post("/api/auth/register", json=data)
    
    assert response.status_code == 201
    assert "access_token" in response.json()
    assert "user_id" in response.json()
    
    # ุงูุชุญูู ูู ุฅูุดุงุก ุงููุณุชุฎุฏู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    user = User.objects.get(username="ahmed_cairo")
    assert user.email == "ahmed@example.com"
    assert user.is_active == True
```

#### **ุงูุณููุงุฑูููุงุช ุงูุณูุจูุฉ:**
```python
def test_user_registration_duplicate_email():
    """ุงุฎุชุจุงุฑ ุชุณุฌูู ุจุฅูููู ููุฑุฑ"""
    # ุฅูุดุงุก ูุณุชุฎุฏู ุฃููุงู
    create_test_user("test@example.com")
    
    data = {
        "email": "test@example.com",  # ุฅูููู ููุฑุฑ
        "username": "new_user",
        # ... ุจุงูู ุงูุจูุงูุงุช
    }
    
    response = client.post("/api/auth/register", json=data)
    
    assert response.status_code == 400
    assert "email already exists" in response.json()["error"]

def test_user_registration_invalid_phone():
    """ุงุฎุชุจุงุฑ ุชุณุฌูู ุจุฑูู ุชููููู ุบูุฑ ุตุญูุญ"""
    data = {
        "phone": "123",  # ุฑูู ุบูุฑ ุตุญูุญ
        # ... ุจุงูู ุงูุจูุงูุงุช
    }
    
    response = client.post("/api/auth/register", json=data)
    
    assert response.status_code == 400
    assert "invalid phone number" in response.json()["error"]

def test_user_registration_weak_password():
    """ุงุฎุชุจุงุฑ ุชุณุฌูู ุจูููุฉ ูุฑูุฑ ุถุนููุฉ"""
    data = {
        "password": "123",  # ูููุฉ ูุฑูุฑ ุถุนููุฉ
        # ... ุจุงูู ุงูุจูุงูุงุช
    }
    
    response = client.post("/api/auth/register", json=data)
    
    assert response.status_code == 400
    assert "password too weak" in response.json()["error"]
```

### **1.2 ุชุณุฌูู ุงูุฏุฎูู**

```python
def test_login_success():
    """ุงุฎุชุจุงุฑ ุชุณุฌูู ุฏุฎูู ูุงุฌุญ"""
    user = create_test_user()
    
    data = {
        "username": user.username,
        "password": "TestPass123!"
    }
    
    response = client.post("/api/auth/login", json=data)
    
    assert response.status_code == 200
    assert "access_token" in response.json()
    assert "refresh_token" in response.json()
    assert response.json()["user"]["id"] == user.id

def test_login_invalid_credentials():
    """ุงุฎุชุจุงุฑ ุชุณุฌูู ุฏุฎูู ุจุจูุงูุงุช ุฎุงุทุฆุฉ"""
    data = {
        "username": "nonexistent",
        "password": "wrongpass"
    }
    
    response = client.post("/api/auth/login", json=data)
    
    assert response.status_code == 401
    assert "invalid credentials" in response.json()["error"]

def test_login_inactive_user():
    """ุงุฎุชุจุงุฑ ุชุณุฌูู ุฏุฎูู ููุณุชุฎุฏู ูุนุทู"""
    user = create_test_user(is_active=False)
    
    data = {
        "username": user.username,
        "password": "TestPass123!"
    }
    
    response = client.post("/api/auth/login", json=data)
    
    assert response.status_code == 403
    assert "account disabled" in response.json()["error"]
```

### **1.3 ุชุฌุฏูุฏ ุงูุฑูุฒ ุงููููุฒ**

```python
def test_token_refresh_success():
    """ุงุฎุชุจุงุฑ ุชุฌุฏูุฏ ุงูุฑูุฒ ุงููููุฒ ุจูุฌุงุญ"""
    user = create_test_user()
    refresh_token = generate_refresh_token(user)
    
    data = {"refresh_token": refresh_token}
    
    response = client.post("/api/auth/refresh", json=data)
    
    assert response.status_code == 200
    assert "access_token" in response.json()
    assert "expires_in" in response.json()

def test_token_refresh_invalid():
    """ุงุฎุชุจุงุฑ ุชุฌุฏูุฏ ุจุฑูุฒ ุบูุฑ ุตุญูุญ"""
    data = {"refresh_token": "invalid_token"}
    
    response = client.post("/api/auth/refresh", json=data)
    
    assert response.status_code == 401
    assert "invalid refresh token" in response.json()["error"]
```

---

## ๐ฅ **2. ุงุฎุชุจุงุฑุงุช ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู**

### **2.1 ุชุณุฌูู ุงููุฑุดุญ**

```python
def test_candidate_registration_success():
    """ุงุฎุชุจุงุฑ ุชุณุฌูู ูุฑุดุญ ุจูุฌุงุญ"""
    party = create_test_party()
    council = create_test_council()
    
    data = {
        "username": "candidate_alex",
        "email": "candidate@example.com",
        "phone": "01098765432",
        "full_name": "ุฏ. ุฃูููุณ ูุญูุฏ",
        "governorate_id": 1,
        "user_type": "candidate",
        "party_id": party.id,
        "council_id": council.id,
        "constituency": "ุงูุฏุงุฆุฑุฉ ุงูุฃููู",
        "electoral_number": "001",
        "electoral_symbol": "ุงููุฎูุฉ",
        "candidate_type": "candidate",
        "biography": "ุฎุจุฑุฉ 15 ุณูุฉ ูู ุงูุชุนููู",
        "promises": "ุชุญุณูู ุงูุชุนููู ูุงูุตุญุฉ"
    }
    
    response = client.post("/api/auth/register", json=data)
    
    assert response.status_code == 201
    
    # ุงูุชุญูู ูู ุฅูุดุงุก ุจูุงูุงุช ุงููุฑุดุญ
    candidate = Candidate.objects.get(user__username="candidate_alex")
    assert candidate.party_id == party.id
    assert candidate.council_id == council.id
    assert candidate.electoral_number == "001"

def test_candidate_registration_duplicate_electoral_number():
    """ุงุฎุชุจุงุฑ ุชุณุฌูู ูุฑุดุญ ุจุฑูู ุงูุชุฎุงุจู ููุฑุฑ"""
    create_test_candidate(electoral_number="001")
    
    data = {
        "electoral_number": "001",  # ุฑูู ููุฑุฑ
        # ... ุจุงูู ุงูุจูุงูุงุช
    }
    
    response = client.post("/api/auth/register", json=data)
    
    assert response.status_code == 400
    assert "electoral number already exists" in response.json()["error"]
```

### **2.2 ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู**

```python
def test_update_user_profile_success():
    """ุงุฎุชุจุงุฑ ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู ุจูุฌุงุญ"""
    user = create_test_user()
    token = generate_access_token(user)
    
    data = {
        "full_name": "ุฃุญูุฏ ูุญูุฏ ุนูู ุงููุญุฏุซ",
        "phone": "01111111111",
        "address": "ุงูุนููุงู ุงูุฌุฏูุฏ"
    }
    
    headers = {"Authorization": f"Bearer {token}"}
    response = client.put(f"/api/users/{user.id}", json=data, headers=headers)
    
    assert response.status_code == 200
    
    # ุงูุชุญูู ูู ุงูุชุญุฏูุซ
    updated_user = User.objects.get(id=user.id)
    assert updated_user.full_name == "ุฃุญูุฏ ูุญูุฏ ุนูู ุงููุญุฏุซ"
    assert updated_user.phone == "01111111111"

def test_update_user_unauthorized():
    """ุงุฎุชุจุงุฑ ุชุญุฏูุซ ุจูุงูุงุช ูุณุชุฎุฏู ุขุฎุฑ (ุบูุฑ ูุตุฑุญ)"""
    user1 = create_test_user()
    user2 = create_test_user(username="user2")
    token = generate_access_token(user1)
    
    data = {"full_name": "ูุญุงููุฉ ุชุญุฏูุซ"}
    
    headers = {"Authorization": f"Bearer {token}"}
    response = client.put(f"/api/users/{user2.id}", json=data, headers=headers)
    
    assert response.status_code == 403
    assert "unauthorized" in response.json()["error"]
```

---

## ๐ **3. ุงุฎุชุจุงุฑุงุช ุงูุดูุงูู**

### **3.1 ุฅุฑุณุงู ุดููู**

```python
def test_submit_complaint_success():
    """ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุดููู ุจูุฌุงุญ"""
    citizen = create_test_user(user_type="citizen")
    candidate = create_test_candidate()
    complaint_type = create_test_complaint_type()
    token = generate_access_token(citizen)
    
    data = {
        "candidate_id": candidate.id,
        "complaint_type_id": complaint_type.id,
        "title": "ูุดููุฉ ูู ุงูุทุฑู",
        "description": "ุงูุทุฑู ูู ุญุงูุฉ ุณูุฆุฉ ุฌุฏุงู",
        "location": "ุดุงุฑุน ุงููููุ ุงููุงูุฑุฉ",
        "youtube_link": "https://youtube.com/watch?v=example"
    }
    
    headers = {"Authorization": f"Bearer {token}"}
    response = client.post("/api/complaints", json=data, headers=headers)
    
    assert response.status_code == 201
    assert "complaint_id" in response.json()
    
    # ุงูุชุญูู ูู ุฅูุดุงุก ุงูุดููู
    complaint = Complaint.objects.get(id=response.json()["complaint_id"])
    assert complaint.title == "ูุดููุฉ ูู ุงูุทุฑู"
    assert complaint.status == "pending"

def test_submit_complaint_with_attachments():
    """ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุดููู ูุน ูุฑููุงุช"""
    citizen = create_test_user(user_type="citizen")
    token = generate_access_token(citizen)
    
    # ุฅูุดุงุก ููู ุชุฌุฑูุจู
    test_file = create_test_file("test_image.jpg", "image/jpeg")
    
    data = {
        "candidate_id": 1,
        "complaint_type_id": 1,
        "title": "ุดููู ูุน ุตูุฑ",
        "description": "ุดููู ูุน ูุฑููุงุช"
    }
    
    files = {"attachments": test_file}
    headers = {"Authorization": f"Bearer {token}"}
    
    response = client.post("/api/complaints", data=data, files=files, headers=headers)
    
    assert response.status_code == 201
    
    # ุงูุชุญูู ูู ุฑูุน ุงููุฑููุงุช
    complaint_id = response.json()["complaint_id"]
    attachments = ComplaintAttachment.objects.filter(complaint_id=complaint_id)
    assert len(attachments) == 1
    assert attachments[0].file_name == "test_image.jpg"

def test_submit_complaint_invalid_file_type():
    """ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุดููู ุจููู ุบูุฑ ูุณููุญ"""
    citizen = create_test_user(user_type="citizen")
    token = generate_access_token(citizen)
    
    # ุฅูุดุงุก ููู ุบูุฑ ูุณููุญ
    test_file = create_test_file("virus.exe", "application/exe")
    
    data = {
        "candidate_id": 1,
        "complaint_type_id": 1,
        "title": "ุดููู",
        "description": "ูุตู"
    }
    
    files = {"attachments": test_file}
    headers = {"Authorization": f"Bearer {token}"}
    
    response = client.post("/api/complaints", data=data, files=files, headers=headers)
    
    assert response.status_code == 400
    assert "file type not allowed" in response.json()["error"]
```

### **3.2 ุนุฑุถ ุงูุดูุงูู**

```python
def test_get_complaints_by_citizen():
    """ุงุฎุชุจุงุฑ ุนุฑุถ ุดูุงูู ุงูููุงุทู"""
    citizen = create_test_user(user_type="citizen")
    complaints = create_test_complaints(citizen, count=5)
    token = generate_access_token(citizen)
    
    headers = {"Authorization": f"Bearer {token}"}
    response = client.get("/api/complaints/my", headers=headers)
    
    assert response.status_code == 200
    assert len(response.json()["complaints"]) == 5
    assert response.json()["total"] == 5

def test_get_complaints_by_candidate():
    """ุงุฎุชุจุงุฑ ุนุฑุถ ุงูุดูุงูู ุงูููุฌูุฉ ูููุฑุดุญ"""
    candidate_user = create_test_user(user_type="candidate")
    candidate = create_test_candidate(user=candidate_user)
    complaints = create_test_complaints_for_candidate(candidate, count=3)
    token = generate_access_token(candidate_user)
    
    headers = {"Authorization": f"Bearer {token}"}
    response = client.get("/api/complaints/received", headers=headers)
    
    assert response.status_code == 200
    assert len(response.json()["complaints"]) == 3

def test_get_complaints_with_filters():
    """ุงุฎุชุจุงุฑ ุนุฑุถ ุงูุดูุงูู ูุน ููุงุชุฑ"""
    citizen = create_test_user(user_type="citizen")
    create_test_complaints_with_status(citizen, "pending", 3)
    create_test_complaints_with_status(citizen, "resolved", 2)
    token = generate_access_token(citizen)
    
    headers = {"Authorization": f"Bearer {token}"}
    response = client.get("/api/complaints/my?status=pending", headers=headers)
    
    assert response.status_code == 200
    assert len(response.json()["complaints"]) == 3
    
    for complaint in response.json()["complaints"]:
        assert complaint["status"] == "pending"
```

---

## ๐ฌ **4. ุงุฎุชุจุงุฑุงุช ุงูุฑุณุงุฆู**

### **4.1 ุฅุฑุณุงู ุฑุณุงูุฉ**

```python
def test_send_message_success():
    """ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุฑุณุงูุฉ ุจูุฌุงุญ"""
    sender = create_test_user(user_type="citizen")
    recipient = create_test_user(user_type="candidate", username="recipient")
    token = generate_access_token(sender)
    
    data = {
        "recipient_id": recipient.id,
        "subject": "ุงุณุชูุณุงุฑ ููู",
        "content": "ุฃุฑูุฏ ุงูุงุณุชูุณุงุฑ ุนู ุจุฑูุงูุฌูู ุงูุงูุชุฎุงุจู",
        "message_type": "direct"
    }
    
    headers = {"Authorization": f"Bearer {token}"}
    response = client.post("/api/messages", json=data, headers=headers)
    
    assert response.status_code == 201
    assert "message_id" in response.json()
    
    # ุงูุชุญูู ูู ุฅูุดุงุก ุงูุฑุณุงูุฉ
    message = Message.objects.get(id=response.json()["message_id"])
    assert message.sender_id == sender.id
    assert message.recipient_id == recipient.id
    assert message.subject == "ุงุณุชูุณุงุฑ ููู"

def test_send_message_to_nonexistent_user():
    """ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุฑุณุงูุฉ ููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ"""
    sender = create_test_user()
    token = generate_access_token(sender)
    
    data = {
        "recipient_id": 99999,  # ูุณุชุฎุฏู ุบูุฑ ููุฌูุฏ
        "subject": "ุฑุณุงูุฉ",
        "content": "ูุญุชูู ุงูุฑุณุงูุฉ"
    }
    
    headers = {"Authorization": f"Bearer {token}"}
    response = client.post("/api/messages", json=data, headers=headers)
    
    assert response.status_code == 404
    assert "recipient not found" in response.json()["error"]

def test_send_message_with_attachment():
    """ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุฑุณุงูุฉ ูุน ูุฑูู"""
    sender = create_test_user()
    recipient = create_test_user(username="recipient")
    token = generate_access_token(sender)
    
    test_file = create_test_file("document.pdf", "application/pdf")
    
    data = {
        "recipient_id": recipient.id,
        "subject": "ูุซููุฉ ูููุฉ",
        "content": "ุฃุฑูู ูู ุงููุซููุฉ ุงููุทููุจุฉ"
    }
    
    files = {"attachment": test_file}
    headers = {"Authorization": f"Bearer {token}"}
    
    response = client.post("/api/messages", data=data, files=files, headers=headers)
    
    assert response.status_code == 201
    
    # ุงูุชุญูู ูู ุฑูุน ุงููุฑูู
    message_id = response.json()["message_id"]
    attachment = MessageAttachment.objects.get(message_id=message_id)
    assert attachment.file_name == "document.pdf"
```

### **4.2 ูุฑุงุกุฉ ุงูุฑุณุงุฆู**

```python
def test_get_inbox_messages():
    """ุงุฎุชุจุงุฑ ุนุฑุถ ุฑุณุงุฆู ุงููุงุฑุฏ"""
    user = create_test_user()
    messages = create_test_messages_for_user(user, count=5)
    token = generate_access_token(user)
    
    headers = {"Authorization": f"Bearer {token}"}
    response = client.get("/api/messages/inbox", headers=headers)
    
    assert response.status_code == 200
    assert len(response.json()["messages"]) == 5
    assert response.json()["unread_count"] >= 0

def test_mark_message_as_read():
    """ุงุฎุชุจุงุฑ ุชูููุฒ ุงูุฑุณุงูุฉ ูููุฑูุกุฉ"""
    user = create_test_user()
    message = create_test_message(recipient=user, is_read=False)
    token = generate_access_token(user)
    
    headers = {"Authorization": f"Bearer {token}"}
    response = client.put(f"/api/messages/{message.id}/read", headers=headers)
    
    assert response.status_code == 200
    
    # ุงูุชุญูู ูู ุชุญุฏูุซ ุญุงูุฉ ุงููุฑุงุกุฉ
    updated_message = Message.objects.get(id=message.id)
    assert updated_message.is_read == True
    assert updated_message.read_at is not None
```

---

## โญ **5. ุงุฎุชุจุงุฑุงุช ุงูุชููููุงุช**

### **5.1 ุฅุถุงูุฉ ุชูููู**

```python
def test_add_rating_success():
    """ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ุชูููู ุจูุฌุงุญ"""
    citizen = create_test_user(user_type="citizen")
    candidate = create_test_candidate()
    token = generate_access_token(citizen)
    
    data = {
        "candidate_id": candidate.id,
        "rating": 4,
        "comment": "ุฃุฏุงุก ุฌูุฏ ูู ุงููุชุฑุฉ ุงููุงุถูุฉ",
        "category": "performance",
        "is_anonymous": False
    }
    
    headers = {"Authorization": f"Bearer {token}"}
    response = client.post("/api/ratings", json=data, headers=headers)
    
    assert response.status_code == 201
    assert "rating_id" in response.json()
    
    # ุงูุชุญูู ูู ุฅูุดุงุก ุงูุชูููู
    rating = Rating.objects.get(id=response.json()["rating_id"])
    assert rating.rating == 4
    assert rating.category == "performance"

def test_add_duplicate_rating():
    """ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ุชูููู ููุฑุฑ (ููุณ ุงูููุงุทู ูููุณ ุงููุฑุดุญ)"""
    citizen = create_test_user(user_type="citizen")
    candidate = create_test_candidate()
    
    # ุฅุถุงูุฉ ุชูููู ุฃูู
    create_test_rating(citizen, candidate, rating=3)
    
    token = generate_access_token(citizen)
    
    data = {
        "candidate_id": candidate.id,
        "rating": 5,
        "comment": "ุชูููู ุฌุฏูุฏ",
        "category": "performance"
    }
    
    headers = {"Authorization": f"Bearer {token}"}
    response = client.post("/api/ratings", json=data, headers=headers)
    
    assert response.status_code == 400
    assert "already rated" in response.json()["error"]

def test_update_existing_rating():
    """ุงุฎุชุจุงุฑ ุชุญุฏูุซ ุชูููู ููุฌูุฏ"""
    citizen = create_test_user(user_type="citizen")
    candidate = create_test_candidate()
    rating = create_test_rating(citizen, candidate, rating=3)
    token = generate_access_token(citizen)
    
    data = {
        "rating": 5,
        "comment": "ุชุญุฏูุซ ุงูุชูููู",
        "category": "overall"
    }
    
    headers = {"Authorization": f"Bearer {token}"}
    response = client.put(f"/api/ratings/{rating.id}", json=data, headers=headers)
    
    assert response.status_code == 200
    
    # ุงูุชุญูู ูู ุงูุชุญุฏูุซ
    updated_rating = Rating.objects.get(id=rating.id)
    assert updated_rating.rating == 5
    assert updated_rating.comment == "ุชุญุฏูุซ ุงูุชูููู"
```

### **5.2 ุนุฑุถ ุงูุชููููุงุช**

```python
def test_get_candidate_ratings():
    """ุงุฎุชุจุงุฑ ุนุฑุถ ุชููููุงุช ุงููุฑุดุญ"""
    candidate = create_test_candidate()
    ratings = create_test_ratings_for_candidate(candidate, count=10)
    
    response = client.get(f"/api/candidates/{candidate.id}/ratings")
    
    assert response.status_code == 200
    assert len(response.json()["ratings"]) == 10
    assert "average_rating" in response.json()
    assert "total_ratings" in response.json()

def test_get_ratings_summary():
    """ุงุฎุชุจุงุฑ ุนุฑุถ ููุฎุต ุงูุชููููุงุช"""
    candidate = create_test_candidate()
    create_test_ratings_with_categories(candidate)
    
    response = client.get(f"/api/candidates/{candidate.id}/ratings/summary")
    
    assert response.status_code == 200
    summary = response.json()
    
    assert "performance_avg" in summary
    assert "communication_avg" in summary
    assert "promises_avg" in summary
    assert "overall_avg" in summary
    assert summary["total_ratings"] > 0
```

---

## ๐ง **6. ุงุฎุชุจุงุฑุงุช ุงูุฅุฏุงุฑุฉ**

### **6.1 ุฅุฏุงุฑุฉ ุงูุฃุญุฒุงุจ**

```python
def test_admin_add_party():
    """ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ุญุฒุจ ุฌุฏูุฏ ูู ุงูุฅุฏุงุฑุฉ"""
    admin = create_test_admin()
    token = generate_access_token(admin)
    
    data = {
        "name_ar": "ุญุฒุจ ุฌุฏูุฏ",
        "name_en": "New Party",
        "logo_url": "https://example.com/logo.png",
        "color": "#FF5733",
        "is_active": True
    }
    
    headers = {"Authorization": f"Bearer {token}"}
    response = client.post("/api/admin/parties", json=data, headers=headers)
    
    assert response.status_code == 201
    assert "party_id" in response.json()
    
    # ุงูุชุญูู ูู ุฅูุดุงุก ุงูุญุฒุจ
    party = Party.objects.get(id=response.json()["party_id"])
    assert party.name_ar == "ุญุฒุจ ุฌุฏูุฏ"
    assert party.color == "#FF5733"

def test_admin_delete_party():
    """ุงุฎุชุจุงุฑ ุญุฐู ุญุฒุจ ูู ุงูุฅุฏุงุฑุฉ"""
    admin = create_test_admin()
    party = create_test_party()
    token = generate_access_token(admin)
    
    headers = {"Authorization": f"Bearer {token}"}
    response = client.delete(f"/api/admin/parties/{party.id}", headers=headers)
    
    assert response.status_code == 200
    
    # ุงูุชุญูู ูู ุงูุญุฐู (soft delete)
    deleted_party = Party.objects.get(id=party.id)
    assert deleted_party.is_active == False

def test_non_admin_cannot_manage_parties():
    """ุงุฎุชุจุงุฑ ููุน ุบูุฑ ุงูุฅุฏุงุฑุฉ ูู ุฅุฏุงุฑุฉ ุงูุฃุญุฒุงุจ"""
    user = create_test_user()  # ูุณุชุฎุฏู ุนุงุฏู
    token = generate_access_token(user)
    
    data = {"name_ar": "ุญุฒุจ", "name_en": "Party"}
    
    headers = {"Authorization": f"Bearer {token}"}
    response = client.post("/api/admin/parties", json=data, headers=headers)
    
    assert response.status_code == 403
    assert "admin access required" in response.json()["error"]
```

### **6.2 ุฅุฏุงุฑุฉ ุฃููุงุน ุงูุดูุงูู**

```python
def test_admin_add_complaint_type():
    """ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ููุน ุดููู ุฌุฏูุฏ"""
    admin = create_test_admin()
    token = generate_access_token(admin)
    
    data = {
        "name_ar": "ุดูุงูู ุงูููุฑุจุงุก",
        "name_en": "Electricity Complaints",
        "council_type": "parliament",
        "color": "#FFC300",
        "icon": "โก",
        "description": "ุดูุงูู ูุชุนููุฉ ุจุงููุทุงุน ุงูููุฑุจุงุก"
    }
    
    headers = {"Authorization": f"Bearer {token}"}
    response = client.post("/api/admin/complaint-types", json=data, headers=headers)
    
    assert response.status_code == 201
    
    # ุงูุชุญูู ูู ุฅูุดุงุก ุงูููุน
    complaint_type = ComplaintType.objects.get(id=response.json()["type_id"])
    assert complaint_type.name_ar == "ุดูุงูู ุงูููุฑุจุงุก"
    assert complaint_type.council_type == "parliament"
```

---

## ๐ **7. ุงุฎุชุจุงุฑุงุช ุงูุฃุฏุงุก**

### **7.1 ุงุฎุชุจุงุฑ ุงูุญูููุฉ**

```python
def test_concurrent_user_registration():
    """ุงุฎุชุจุงุฑ ุชุณุฌูู ูุณุชุฎุฏููู ูุชุฒุงูู"""
    import threading
    import time
    
    results = []
    
    def register_user(index):
        data = {
            "username": f"user_{index}",
            "email": f"user{index}@example.com",
            "phone": f"0101234567{index % 10}",
            "full_name": f"ูุณุชุฎุฏู {index}",
            "governorate_id": 1,
            "user_type": "citizen",
            "password": "TestPass123!"
        }
        
        start_time = time.time()
        response = client.post("/api/auth/register", json=data)
        end_time = time.time()
        
        results.append({
            "status_code": response.status_code,
            "response_time": end_time - start_time
        })
    
    # ุฅูุดุงุก 50 thread ููุชุณุฌูู ุงููุชุฒุงูู
    threads = []
    for i in range(50):
        thread = threading.Thread(target=register_user, args=(i,))
        threads.append(thread)
    
    # ุจุฏุก ุฌููุน ุงูู threads
    for thread in threads:
        thread.start()
    
    # ุงูุชุธุงุฑ ุงูุชูุงุก ุฌููุน ุงูู threads
    for thread in threads:
        thread.join()
    
    # ุชุญููู ุงููุชุงุฆุฌ
    success_count = sum(1 for r in results if r["status_code"] == 201)
    avg_response_time = sum(r["response_time"] for r in results) / len(results)
    
    assert success_count >= 45  # 90% ูุฌุงุญ ุนูู ุงูุฃูู
    assert avg_response_time < 2.0  # ุฃูู ูู ุซุงููุชูู ูู ุงููุชูุณุท

def test_database_query_performance():
    """ุงุฎุชุจุงุฑ ุฃุฏุงุก ุงุณุชุนูุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช"""
    # ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ ูุจูุฑุฉ
    create_test_users(count=1000)
    create_test_candidates(count=100)
    create_test_complaints(count=5000)
    
    import time
    
    # ุงุฎุชุจุงุฑ ุงุณุชุนูุงู ูุนูุฏ
    start_time = time.time()
    
    response = client.get("/api/candidates?governorate=1&party=1&page=1&limit=20")
    
    end_time = time.time()
    query_time = end_time - start_time
    
    assert response.status_code == 200
    assert query_time < 1.0  # ุฃูู ูู ุซุงููุฉ ูุงุญุฏุฉ
    assert len(response.json()["candidates"]) <= 20
```

### **7.2 ุงุฎุชุจุงุฑ ุงูุฐุงูุฑุฉ**

```python
def test_memory_usage_large_file_upload():
    """ุงุฎุชุจุงุฑ ุงุณุชููุงู ุงูุฐุงูุฑุฉ ุนูุฏ ุฑูุน ูููุงุช ูุจูุฑุฉ"""
    import psutil
    import os
    
    citizen = create_test_user(user_type="citizen")
    token = generate_access_token(citizen)
    
    # ููุงุณ ุงูุฐุงูุฑุฉ ูุจู ุงูุฑูุน
    process = psutil.Process(os.getpid())
    memory_before = process.memory_info().rss / 1024 / 1024  # MB
    
    # ุฅูุดุงุก ููู ูุจูุฑ (5MB)
    large_file = create_test_file("large_image.jpg", "image/jpeg", size_mb=5)
    
    data = {
        "candidate_id": 1,
        "complaint_type_id": 1,
        "title": "ุดููู ูุน ููู ูุจูุฑ",
        "description": "ุงุฎุชุจุงุฑ ุฑูุน ููู ูุจูุฑ"
    }
    
    files = {"attachments": large_file}
    headers = {"Authorization": f"Bearer {token}"}
    
    response = client.post("/api/complaints", data=data, files=files, headers=headers)
    
    # ููุงุณ ุงูุฐุงูุฑุฉ ุจุนุฏ ุงูุฑูุน
    memory_after = process.memory_info().rss / 1024 / 1024  # MB
    memory_increase = memory_after - memory_before
    
    assert response.status_code == 201
    assert memory_increase < 50  # ุฒูุงุฏุฉ ุฃูู ูู 50MB
```

---

## ๐ก๏ธ **8. ุงุฎุชุจุงุฑุงุช ุงูุฃูุงู**

### **8.1 ุงุฎุชุจุงุฑ SQL Injection**

```python
def test_sql_injection_protection():
    """ุงุฎุชุจุงุฑ ุงูุญูุงูุฉ ูู SQL Injection"""
    malicious_input = "'; DROP TABLE users; --"
    
    data = {
        "username": malicious_input,
        "password": "password"
    }
    
    response = client.post("/api/auth/login", json=data)
    
    # ูุฌุจ ุฃู ููุดู ุชุณุฌูู ุงูุฏุฎูู ุฏูู ุชุฃุซูุฑ ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    assert response.status_code == 401
    
    # ุงูุชุญูู ูู ุฃู ุฌุฏูู ุงููุณุชุฎุฏููู ูุง ุฒุงู ููุฌูุฏุงู
    users_count = User.objects.count()
    assert users_count >= 0  # ุงูุฌุฏูู ูู ููุญุฐู

def test_xss_protection():
    """ุงุฎุชุจุงุฑ ุงูุญูุงูุฉ ูู XSS"""
    citizen = create_test_user(user_type="citizen")
    token = generate_access_token(citizen)
    
    malicious_script = "<script>alert('XSS')</script>"
    
    data = {
        "candidate_id": 1,
        "complaint_type_id": 1,
        "title": malicious_script,
        "description": "ูุตู ุนุงุฏู"
    }
    
    headers = {"Authorization": f"Bearer {token}"}
    response = client.post("/api/complaints", json=data, headers=headers)
    
    assert response.status_code == 201
    
    # ุงูุชุญูู ูู ุชูุธูู ุงููุญุชูู
    complaint = Complaint.objects.get(id=response.json()["complaint_id"])
    assert "<script>" not in complaint.title
    assert "alert" not in complaint.title
```

### **8.2 ุงุฎุชุจุงุฑ Rate Limiting**

```python
def test_rate_limiting():
    """ุงุฎุชุจุงุฑ ุชุญุฏูุฏ ูุนุฏู ุงูุทูุจุงุช"""
    user = create_test_user()
    
    # ุฅุฑุณุงู ุทูุจุงุช ูุชุชุงููุฉ ุณุฑูุนุฉ
    responses = []
    for i in range(20):  # 20 ุทูุจ ูู ุซุงููุฉ ูุงุญุฏุฉ
        response = client.post("/api/auth/login", json={
            "username": user.username,
            "password": "wrong_password"
        })
        responses.append(response.status_code)
    
    # ูุฌุจ ุฃู ุชูุฑูุถ ุจุนุถ ุงูุทูุจุงุช ุจุณุจุจ Rate Limiting
    rate_limited_count = sum(1 for status in responses if status == 429)
    assert rate_limited_count > 0

def test_jwt_token_expiration():
    """ุงุฎุชุจุงุฑ ุงูุชูุงุก ุตูุงุญูุฉ JWT Token"""
    user = create_test_user()
    
    # ุฅูุดุงุก token ููุชูู ุงูุตูุงุญูุฉ
    expired_token = generate_expired_token(user)
    
    headers = {"Authorization": f"Bearer {expired_token}"}
    response = client.get("/api/users/profile", headers=headers)
    
    assert response.status_code == 401
    assert "token expired" in response.json()["error"]
```

---

## ๐ฑ **9. ุงุฎุชุจุงุฑุงุช ุงููุงุฌูุฉ ุงูุฃูุงููุฉ (E2E)**

### **9.1 ุงุฎุชุจุงุฑ ุฑุญูุฉ ุงููุณุชุฎุฏู ุงููุงููุฉ**

```python
def test_complete_user_journey():
    """ุงุฎุชุจุงุฑ ุฑุญูุฉ ุงููุณุชุฎุฏู ูู ุงูุชุณุฌูู ุฅูู ุฅุฑุณุงู ุดููู"""
    from selenium import webdriver
    from selenium.webdriver.common.by import By
    from selenium.webdriver.support.ui import WebDriverWait
    from selenium.webdriver.support import expected_conditions as EC
    
    driver = webdriver.Chrome()
    wait = WebDriverWait(driver, 10)
    
    try:
        # 1. ูุชุญ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
        driver.get("http://localhost:3000")
        assert "ูุงุฆุจู" in driver.title
        
        # 2. ุงูููุฑ ุนูู ุฒุฑ ุงูุชุณุฌูู
        register_btn = wait.until(EC.element_to_be_clickable((By.ID, "register-btn")))
        register_btn.click()
        
        # 3. ููุก ูููุฐุฌ ุงูุชุณุฌูู
        driver.find_element(By.ID, "username").send_keys("test_user")
        driver.find_element(By.ID, "email").send_keys("test@example.com")
        driver.find_element(By.ID, "phone").send_keys("01012345678")
        driver.find_element(By.ID, "full_name").send_keys("ูุณุชุฎุฏู ุชุฌุฑูุจู")
        driver.find_element(By.ID, "password").send_keys("TestPass123!")
        
        # ุงุฎุชูุงุฑ ุงููุญุงูุธุฉ
        governorate_select = driver.find_element(By.ID, "governorate")
        governorate_select.send_keys("ุงููุงูุฑุฉ")
        
        # ุฅุฑุณุงู ุงููููุฐุฌ
        submit_btn = driver.find_element(By.ID, "submit-register")
        submit_btn.click()
        
        # 4. ุงูุชุญูู ูู ูุฌุงุญ ุงูุชุณุฌูู
        success_msg = wait.until(EC.presence_of_element_located((By.CLASS_NAME, "success-message")))
        assert "ุชู ุงูุชุณุฌูู ุจูุฌุงุญ" in success_msg.text
        
        # 5. ุงูุงูุชูุงู ุฅูู ุตูุญุฉ ุงูุดูุงูู
        complaints_link = wait.until(EC.element_to_be_clickable((By.ID, "complaints-link")))
        complaints_link.click()
        
        # 6. ุฅุฑุณุงู ุดููู ุฌุฏูุฏุฉ
        new_complaint_btn = wait.until(EC.element_to_be_clickable((By.ID, "new-complaint-btn")))
        new_complaint_btn.click()
        
        # ููุก ูููุฐุฌ ุงูุดููู
        driver.find_element(By.ID, "complaint-title").send_keys("ูุดููุฉ ูู ุงูุทุฑู")
        driver.find_element(By.ID, "complaint-description").send_keys("ุงูุทุฑู ูู ุญุงูุฉ ุณูุฆุฉ")
        
        # ุงุฎุชูุงุฑ ุงููุฑุดุญ
        candidate_select = driver.find_element(By.ID, "candidate-select")
        candidate_select.send_keys("ุฏ. ุฃุญูุฏ ูุญูุฏ")
        
        # ุฅุฑุณุงู ุงูุดููู
        submit_complaint_btn = driver.find_element(By.ID, "submit-complaint")
        submit_complaint_btn.click()
        
        # 7. ุงูุชุญูู ูู ูุฌุงุญ ุฅุฑุณุงู ุงูุดููู
        success_msg = wait.until(EC.presence_of_element_located((By.CLASS_NAME, "complaint-success")))
        assert "ุชู ุฅุฑุณุงู ุงูุดููู ุจูุฌุงุญ" in success_msg.text
        
    finally:
        driver.quit()

def test_responsive_design():
    """ุงุฎุชุจุงุฑ ุงูุชุตููู ุงููุชุฌุงูุจ"""
    from selenium import webdriver
    
    driver = webdriver.Chrome()
    
    try:
        driver.get("http://localhost:3000")
        
        # ุงุฎุชุจุงุฑ ุนูู ุฃุญุฌุงู ุดุงุดุฉ ูุฎุชููุฉ
        screen_sizes = [
            (1920, 1080),  # Desktop
            (768, 1024),   # Tablet
            (375, 667)     # Mobile
        ]
        
        for width, height in screen_sizes:
            driver.set_window_size(width, height)
            
            # ุงูุชุญูู ูู ุธููุฑ ุงูุนูุงุตุฑ ุงูุฃุณุงุณูุฉ
            header = driver.find_element(By.TAG_NAME, "header")
            assert header.is_displayed()
            
            footer = driver.find_element(By.TAG_NAME, "footer")
            assert footer.is_displayed()
            
            # ุงูุชุญูู ูู ุงููุงุฆูุฉ ุงููุชุฌุงูุจุฉ ุนูู ุงูููุจุงูู
            if width <= 768:
                menu_toggle = driver.find_element(By.CLASS_NAME, "menu-toggle")
                assert menu_toggle.is_displayed()
    
    finally:
        driver.quit()
```

---

## ๐ **10. ุชูุงุฑูุฑ ุงูุงุฎุชุจุงุฑ**

### **10.1 ุฅุนุฏุงุฏ ุชูุงุฑูุฑ HTML**

```python
# pytest.ini
[tool:pytest]
addopts = --html=reports/report.html --self-contained-html --cov=. --cov-report=html:reports/coverage

def generate_test_report():
    """ุฅูุดุงุก ุชูุฑูุฑ ุดุงูู ููุงุฎุชุจุงุฑุงุช"""
    import subprocess
    import datetime
    
    # ุชุดุบูู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช
    result = subprocess.run([
        "pytest", 
        "--html=reports/test_report.html",
        "--cov=.",
        "--cov-report=html:reports/coverage",
        "--junitxml=reports/junit.xml",
        "-v"
    ], capture_output=True, text=True)
    
    # ุฅูุดุงุก ููุฎุต ุงููุชุงุฆุฌ
    report_summary = {
        "timestamp": datetime.datetime.now().isoformat(),
        "total_tests": result.stdout.count("PASSED") + result.stdout.count("FAILED"),
        "passed": result.stdout.count("PASSED"),
        "failed": result.stdout.count("FAILED"),
        "coverage": extract_coverage_percentage(result.stdout),
        "duration": extract_test_duration(result.stdout)
    }
    
    return report_summary
```

### **10.2 ุงุฎุชุจุงุฑุงุช ุงูุฃุฏุงุก ุงููุณุชูุฑุฉ**

```python
def test_performance_benchmarks():
    """ุงุฎุชุจุงุฑ ูุนุงููุฑ ุงูุฃุฏุงุก"""
    benchmarks = {
        "user_registration": {"max_time": 2.0, "success_rate": 0.95},
        "user_login": {"max_time": 1.0, "success_rate": 0.99},
        "complaint_submission": {"max_time": 3.0, "success_rate": 0.90},
        "message_sending": {"max_time": 1.5, "success_rate": 0.95},
        "rating_submission": {"max_time": 1.0, "success_rate": 0.98}
    }
    
    results = {}
    
    for test_name, benchmark in benchmarks.items():
        # ุชุดุบูู ุงูุงุฎุชุจุงุฑ 100 ูุฑุฉ
        times = []
        successes = 0
        
        for _ in range(100):
            start_time = time.time()
            success = run_performance_test(test_name)
            end_time = time.time()
            
            times.append(end_time - start_time)
            if success:
                successes += 1
        
        avg_time = sum(times) / len(times)
        success_rate = successes / 100
        
        results[test_name] = {
            "avg_time": avg_time,
            "success_rate": success_rate,
            "passed": avg_time <= benchmark["max_time"] and success_rate >= benchmark["success_rate"]
        }
        
        # ุงูุชุญูู ูู ุงููุนุงููุฑ
        assert avg_time <= benchmark["max_time"], f"{test_name} too slow: {avg_time}s"
        assert success_rate >= benchmark["success_rate"], f"{test_name} success rate too low: {success_rate}"
    
    return results
```

---

## ๐ฏ **ุฎูุงุตุฉ ุงุณุชุฑุงุชูุฌูุฉ ุงูุงุฎุชุจุงุฑ**

### **ูุนุงููุฑ ุงููุฌุงุญ:**
- โ **ุชุบุทูุฉ ุงูููุฏ**: 85%+
- โ **ูุนุฏู ุงููุฌุงุญ**: 95%+
- โ **ููุช ุงูุงุณุชุฌุงุจุฉ**: < 2 ุซุงููุฉ
- โ **ุงูุฃูุงู**: 100% ุญูุงูุฉ ูู ุงูุซุบุฑุงุช ุงูุดุงุฆุนุฉ

### **ุฃุฏูุงุช ุงูุงุฎุชุจุงุฑ:**
- **pytest**: ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ ูุงูุชูุงูู
- **Selenium**: ุงุฎุชุจุงุฑุงุช ุงููุงุฌูุฉ ุงูุฃูุงููุฉ
- **locust**: ุงุฎุชุจุงุฑุงุช ุงูุญูููุฉ
- **coverage.py**: ููุงุณ ุชุบุทูุฉ ุงูููุฏ

### **ุงูุชุดุบูู ุงูุชููุงุฆู:**
```bash
# ุชุดุบูู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช
pytest

# ุชุดุบูู ุงุฎุชุจุงุฑุงุช ูุญุฏุฏุฉ
pytest tests/test_auth.py

# ุชุดุบูู ูุน ุชูุฑูุฑ ุงูุชุบุทูุฉ
pytest --cov=. --cov-report=html

# ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุงูุฃุฏุงุก
pytest tests/test_performance.py -v
```

ูุฐู ุงูุณููุงุฑูููุงุช ุชุบุทู ุฌููุน ุฌูุงูุจ ุงูุชุทุจูู ูุชุถูู ุฌูุฏุฉ ุนุงููุฉ ูุฃุฏุงุก ููุชุงุฒ.
